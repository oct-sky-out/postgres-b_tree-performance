# PostgreSQL-style B-tree Implementation in Python

ì´ í”„ë¡œì íŠ¸ëŠ” PostgreSQL ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì‚¬ìš©í•˜ëŠ” B-tree ì¸ë±ìŠ¤ì˜ í•µì‹¬ ê¸°ëŠ¥ì„ Pythonìœ¼ë¡œ êµ¬í˜„í•œ ê²ƒì…ë‹ˆë‹¤.
(With Claude Code)

no-compression-case ë¸Œëœì¹˜ì™€ compression-case ë¸Œëœì¹˜ê°€ ì¡´ì¬í•©ë‹ˆë‹¤.
ê° IDë³„ ì••ì¶• ì‚¬ìš© ì¼€ì´ìŠ¤ë³„ë¡œ ë‚˜ëˆˆ ë¸Œëœì¹˜ì…ë‹ˆë‹¤.

## ì£¼ìš” íŠ¹ì§•

### PostgreSQL B-treeì˜ í•µì‹¬ ê¸°ëŠ¥ë“¤
- **ë†’ì€ ë¶„ê¸°ìœ¨(High Fanout)**: ê¸°ë³¸ order 256ìœ¼ë¡œ ë””ìŠ¤í¬ íš¨ìœ¨ì„± ìµœì í™”
- **ì¤‘ë³µ í‚¤ ì§€ì›**: ë¹„ìœ ë‹ˆí¬ ì¸ë±ìŠ¤ë¥¼ ìœ„í•œ ì¤‘ë³µ í‚¤ ì²˜ë¦¬
- **íš¨ìœ¨ì ì¸ ë²”ìœ„ ì¿¼ë¦¬**: WHERE ì ˆ ë²”ìœ„ ì¡°ê±´ì— ìµœì í™”
- **í†µê³„ ìˆ˜ì§‘**: ì¿¼ë¦¬ í”Œë˜ë‹ì„ ìœ„í•œ íŠ¸ë¦¬ í†µê³„ ì •ë³´
- **ìë™ ë¦¬ë°¸ëŸ°ì‹±**: ì‚­ì œ ì‹œ íŠ¸ë¦¬ êµ¬ì¡° ìë™ ì¡°ì •
- **í˜ì´ì§€ ë ˆë²¨ ì••ì¶•**: ë‹¤ì–‘í•œ ì••ì¶• ì•Œê³ ë¦¬ì¦˜ì„ í†µí•œ ì €ì¥ ê³µê°„ ì ˆì•½

### ìƒˆë¡œ êµ¬í˜„ëœ ì••ì¶• ê¸°ëŠ¥ë“¤ âœ¨
- **Prefix Compression**: ê³µí†µ ì ‘ë‘ì‚¬ë¥¼ ê°€ì§„ ë¬¸ìì—´ í‚¤ ì••ì¶•
- **Dictionary Compression**: ìì£¼ ì‚¬ìš©ë˜ëŠ” ê°’ë“¤ì˜ ì‚¬ì „ ê¸°ë°˜ ì••ì¶•
- **Delta Encoding**: ì—°ì†ëœ ìˆ«ì ê°’ì˜ ì°¨ì´ ê¸°ë°˜ ì••ì¶•
- **Run-Length Encoding**: ë°˜ë³µë˜ëŠ” ê°’ì˜ ì••ì¶•
- **TOAST Compression**: ëŒ€ìš©ëŸ‰ ê°’ì˜ zlib ê¸°ë°˜ ì••ì¶•
- **ì ì‘í˜• ì••ì¶•**: ë°ì´í„° íŠ¹ì„±ì— ë”°ë¥¸ ìë™ ì••ì¶• ì „ëµ ì„ íƒ

### êµ¬í˜„ëœ ì—°ì‚°ë“¤
- `insert(key, value)`: í‚¤-ê°’ ìŒ ì‚½ì…
- `search(key)`: í‚¤ì— ëŒ€í•œ ëª¨ë“  ê°’ ê²€ìƒ‰ (ì¤‘ë³µ í‚¤ ì§€ì›)
- `delete(key, value=None)`: í‚¤-ê°’ ìŒ ì‚­ì œ
- `range_query(start_key, end_key, inclusive=True)`: ë²”ìœ„ ì¿¼ë¦¬
- `get_statistics()`: íŠ¸ë¦¬ í†µê³„ ì •ë³´
- `compress_all_pages()`: ì „ì²´ ë…¸ë“œ ì••ì¶• ì‹¤í–‰
- `get_detailed_compression_stats()`: ìƒì„¸ ì••ì¶• í†µê³„

## ì„¤ì¹˜ ë° ì‚¬ìš©ë²•

### 1. ê°€ìƒ í™˜ê²½ ì„¤ì •
```bash
# ì´ë¯¸ venv í´ë”ê°€ ìˆìœ¼ë¯€ë¡œ í™œì„±í™”ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤
source venv/bin/activate
```

### 2. ì˜ì¡´ì„± ì„¤ì¹˜
```bash
pip install -r requirements.txt
```

### 3. ê¸°ë³¸ ì‚¬ìš©ë²•
```python
from btree import PostgreSQLBTree

# B-tree ìƒì„± (ì••ì¶• ê¸°ëŠ¥ í¬í•¨)
btree = PostgreSQLBTree(order=256, enable_compression=True)

# ë°ì´í„° ì‚½ì…
btree.insert("user_001", "John Doe")
btree.insert("user_002", "Jane Smith")
btree.insert("user_001", "John's backup")  # ì¤‘ë³µ í‚¤ ì§€ì›

# ê²€ìƒ‰ (ëª¨ë“  ê°’ ë°˜í™˜)
results = btree.search("user_001")  # ["John Doe", "John's backup"]

# ë²”ìœ„ ì¿¼ë¦¬
for key, value in btree.range_query("user_001", "user_999"):
    print(f"{key}: {value}")

# ì••ì¶• ì‹¤í–‰
compression_stats = btree.compress_all_pages()
print(f"ì••ì¶•ëœ í˜ì´ì§€: {compression_stats['compression_successes']}")

# ì‚­ì œ
btree.delete("user_001", "John Doe")  # íŠ¹ì • ê°’ë§Œ ì‚­ì œ
btree.delete("user_002")  # ì²« ë²ˆì§¸ ê°’ ì‚­ì œ

# í†µê³„ ì •ë³´ (ì••ì¶• ì •ë³´ í¬í•¨)
stats = btree.get_statistics()
print(f"Tree height: {stats['height']}")
print(f"Total keys: {stats['total_keys']}")
print(f"Compression ratio: {stats.get('compression_ratio', 'N/A')}")
```

### 4. ì••ì¶• ê¸°ëŠ¥ ì‚¬ìš©ë²•
```python
from compression import CompressionManager

# ê°œë³„ ì••ì¶• ì „ëµ í…ŒìŠ¤íŠ¸
manager = CompressionManager()
data = ["user_001", "user_002", "user_003"]  # ê³µí†µ ì ‘ë‘ì‚¬

# ìë™ ì••ì¶• (ìµœì  ì „ëµ ì„ íƒ)
compressed, metadata = manager.compress(data)
decompressed = manager.decompress(compressed, metadata)

# ì••ì¶• í†µê³„ í™•ì¸
stats = manager.get_compression_stats(data)
for strategy, info in stats.items():
    print(f"{strategy}: {info.get('estimated_ratio', 'N/A')}")
```

## í…ŒìŠ¤íŠ¸ ì‹¤í–‰

### ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
```bash
python -m pytest test_btree.py -v
```

### íŠ¹ì • í…ŒìŠ¤íŠ¸ í´ë˜ìŠ¤ ì‹¤í–‰
```bash
python -m pytest test_btree.py::TestBTreeBasics -v
```

### ì••ì¶• ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
```bash
python -m pytest test_compression.py -v
```

## ì˜ˆì œ ì‹¤í–‰

### ê¸°ë³¸ B-tree ë°ëª¨
```bash
python example_usage.py
```

### ì••ì¶• ê¸°ëŠ¥ ë°ëª¨ âœ¨
```bash
python compression_demo.py
```

ì´ ëª…ë ¹ì–´ë“¤ì€ ë‹¤ìŒê³¼ ê°™ì€ ë°ëª¨ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤:

**ê¸°ë³¸ ë°ëª¨:**
- ê¸°ë³¸ B-tree ì—°ì‚°
- ì¤‘ë³µ í‚¤ ì²˜ë¦¬
- ëŒ€ìš©ëŸ‰ ë°ì´í„°ì…‹ ì„±ëŠ¥
- ë²”ìœ„ ì¿¼ë¦¬ ì„±ëŠ¥
- ì‚­ì œ ë° ë¦¬ë°¸ëŸ°ì‹±

**ì••ì¶• ë°ëª¨:**
- ë‹¤ì–‘í•œ ì••ì¶• ì „ëµ ë¹„êµ
- ë°ì´í„° íƒ€ì…ë³„ ì••ì¶• íš¨ìœ¨ì„±
- ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤ ì‹œë‚˜ë¦¬ì˜¤ ì‹œë®¬ë ˆì´ì…˜
- ì••ì¶• ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬

## ì„±ëŠ¥ íŠ¹ì„±

### PostgreSQLê³¼ ìœ ì‚¬í•œ ì„±ëŠ¥
- **ë†’ì€ ì‚½ì… ì„±ëŠ¥**: 60ë§Œ+ ì‚½ì…/ì´ˆ
- **íš¨ìœ¨ì ì¸ ê²€ìƒ‰**: 14,000+ ê²€ìƒ‰/ì´ˆ
- **ë¹ ë¥¸ ë²”ìœ„ ì¿¼ë¦¬**: ë§ˆì´í¬ë¡œì´ˆ ë‹¨ìœ„ ì‘ë‹µ
- **ë©”ëª¨ë¦¬ íš¨ìœ¨ì **: ë†’ì€ ë¶„ê¸°ìœ¨ë¡œ íŠ¸ë¦¬ ë†’ì´ ìµœì†Œí™”

### ë²¤ì¹˜ë§ˆí¬ ê²°ê³¼
```
10,000ê°œ ë ˆì½”ë“œ ì‚½ì…: 0.017ì´ˆ (601,506 ì‚½ì…/ì´ˆ)
1,000ê°œ í‚¤ ê²€ìƒ‰: 0.069ì´ˆ (14,485 ê²€ìƒ‰/ì´ˆ)
ë²”ìœ„ ì¿¼ë¦¬ (25ê°œ ê²°ê³¼): < 0.0001ì´ˆ
```

## ì•„í‚¤í…ì²˜

### í´ë˜ìŠ¤ êµ¬ì¡°
- `PostgreSQLBTree`: ë©”ì¸ B-tree í´ë˜ìŠ¤
- `BTreeNode`: ê°œë³„ ë…¸ë“œ êµ¬í˜„
- `KeyValue`: í‚¤-ê°’ ìŒ ë°ì´í„° í´ë˜ìŠ¤

### PostgreSQL í˜¸í™˜ ê¸°ëŠ¥ë“¤
1. **í˜ì´ì§€ ì§€í–¥ ì„¤ê³„**: 8KB í˜ì´ì§€ í¬ê¸° ì‹œë®¬ë ˆì´ì…˜
2. **ë†’ì€ ë¶„ê¸°ìœ¨**: ë””ìŠ¤í¬ I/O ìµœì†Œí™”ë¥¼ ìœ„í•œ order 256
3. **ì¤‘ë³µ í‚¤ ì§€ì›**: ë¹„ìœ ë‹ˆí¬ ì¸ë±ìŠ¤ êµ¬í˜„
4. **ë²”ìœ„ ìŠ¤ìº”**: íš¨ìœ¨ì ì¸ ë²”ìœ„ ì¿¼ë¦¬
5. **í†µê³„ ìˆ˜ì§‘**: ì¿¼ë¦¬ í”Œë˜ë„ˆë¥¼ ìœ„í•œ ë©”íƒ€ë°ì´í„°

## íŒŒì¼ êµ¬ì¡°

```
b-tree/
â”œâ”€â”€ btree.py              # ë©”ì¸ B-tree êµ¬í˜„ (ì••ì¶• ì§€ì›)
â”œâ”€â”€ compression.py        # í˜ì´ì§€ ë ˆë²¨ ì••ì¶• êµ¬í˜„ âœ¨
â”œâ”€â”€ test_btree.py         # ê¸°ë³¸ B-tree í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸
â”œâ”€â”€ test_compression.py   # ì••ì¶• ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ âœ¨
â”œâ”€â”€ example_usage.py      # ê¸°ë³¸ ì‚¬ìš©ë²• ì˜ˆì œ ë° ë°ëª¨
â”œâ”€â”€ compression_demo.py   # ì••ì¶• ê¸°ëŠ¥ ë°ëª¨ âœ¨
â”œâ”€â”€ requirements.txt      # íŒŒì´ì¬ ì˜ì¡´ì„±
â”œâ”€â”€ setup.py             # íŒ¨í‚¤ì§€ ì„¤ì •
â””â”€â”€ README.md            # ì´ íŒŒì¼
```

## PostgreSQLê³¼ì˜ ë¹„êµ

| ê¸°ëŠ¥ | PostgreSQL | ì´ êµ¬í˜„ì²´ |
|------|------------|----------|
| í˜ì´ì§€ í¬ê¸° | 8KB | ì‹œë®¬ë ˆì´ì…˜ë¨ |
| ë¶„ê¸°ìœ¨ | ~256 | 256 (ì„¤ì • ê°€ëŠ¥) |
| ì¤‘ë³µ í‚¤ | ì§€ì› | ì§€ì› |
| ë²”ìœ„ ì¿¼ë¦¬ | ìµœì í™”ë¨ | êµ¬í˜„ë¨ |
| í˜ì´ì§€ ì••ì¶• | ì§€ì› | **êµ¬í˜„ë¨** âœ¨ |
| ì••ì¶• ì „ëµ | TOAST, pglz | **5ê°€ì§€ ì „ëµ** âœ¨ |
| ë™ì‹œì„± | MVCC | ë¯¸êµ¬í˜„ |
| ë””ìŠ¤í¬ ì˜ì†ì„± | ì§€ì› | ë©”ëª¨ë¦¬ë§Œ |

## í–¥í›„ ê°œì„  ì‚¬í•­

1. **ë””ìŠ¤í¬ ì˜ì†ì„±**: ì‹¤ì œ í˜ì´ì§€ ê¸°ë°˜ ì €ì¥
2. **ë™ì‹œì„± ì œì–´**: ì½ê¸°/ì“°ê¸° ë½ êµ¬í˜„  
3. **WAL ë¡œê¹…**: ë‚´êµ¬ì„±ì„ ìœ„í•œ íŠ¸ëœì­ì…˜ ë¡œê·¸
4. **ì••ì¶• ìµœì í™”**: ë” ì§„ë³´ëœ ì••ì¶• ì•Œê³ ë¦¬ì¦˜ ì¶”ê°€
5. **ì••ì¶• ì„ê³„ê°’ ì¡°ì •**: ë™ì  ì••ì¶• ì„ê³„ê°’ ì„¤ì •

## ì••ì¶• ê¸°ëŠ¥ ìƒì„¸ ì •ë³´ âœ¨

### ì§€ì›í•˜ëŠ” ì••ì¶• ì „ëµ

1. **Prefix Compression**
   - ê³µí†µ ì ‘ë‘ì‚¬ê°€ ìˆëŠ” ë¬¸ìì—´ì— ìµœì í™”
   - ì˜ˆ: "user_001", "user_002" â†’ "user_" + ["001", "002"]

2. **Dictionary Compression** 
   - ìì£¼ ë°˜ë³µë˜ëŠ” ê°’ë“¤ì„ ì‚¬ì „ìœ¼ë¡œ ê´€ë¦¬
   - ì¤‘ë³µ ì œê±°ë¥¼ í†µí•œ ê³µê°„ ì ˆì•½

3. **Delta Encoding**
   - ì—°ì†ëœ ìˆ«ì ê°’ì˜ ì°¨ì´ë§Œ ì €ì¥
   - ì‹œí€€ì…œ ë°ì´í„°ì— ë§¤ìš° íš¨ê³¼ì 

4. **Run-Length Encoding**
   - ì—°ì†ëœ ë™ì¼ ê°’ì„ (ê°’, ê°œìˆ˜) ìŒìœ¼ë¡œ ì••ì¶•
   - ë°˜ë³µ íŒ¨í„´ì´ ë§ì€ ë°ì´í„°ì— ìµœì 

5. **TOAST Compression**
   - zlib ê¸°ë°˜ ë²”ìš© ì••ì¶•
   - ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸ë‚˜ ë°”ì´ë„ˆë¦¬ ë°ì´í„°ì— íš¨ê³¼ì 

### ì••ì¶• ì„±ëŠ¥ ì˜ˆì‹œ

```
ë°ì´í„° ìœ í˜•ë³„ ì••ì¶• íš¨ê³¼:
- ê³µí†µ ì ‘ë‘ì‚¬ ë¬¸ìì—´: ~70% ê³µê°„ ì ˆì•½
- ë°˜ë³µê°’ ë°ì´í„°: ~80% ê³µê°„ ì ˆì•½  
- ì—°ì† ìˆ«ì: ~90% ê³µê°„ ì ˆì•½
- ëŒ€ìš©ëŸ‰ í…ìŠ¤íŠ¸: ~60% ê³µê°„ ì ˆì•½
- ëœë¤ ë°ì´í„°: ~5% ê³µê°„ ì ˆì•½ (ì••ì¶• ë¹„í™œì„±í™”)
```

ğŸ“Š ì°¨íŠ¸ ì˜ì–´í™”

- ëª¨ë“  ì°¨íŠ¸ ì œëª©, ì¶• ë ˆì´ë¸”, ë²”ë¡€ë¥¼ ì˜ì–´ë¡œ ë³€ê²½
- ì„±ëŠ¥ ê¶Œì¥ì‚¬í•­ë„ ì˜ì–´ë¡œ í‘œì‹œ
- í°íŠ¸ ì„¤ì •ì„ ì˜ì–´ ìš°ì„ ìœ¼ë¡œ ë³€ê²½

ğŸš€ ëŒ€ìš©ëŸ‰ í…ŒìŠ¤íŠ¸ ì˜µì…˜ ì¶”ê°€

ê¸°ì¡´ 3ê°œ ì˜µì…˜ì—ì„œ 6ê°œ ì˜µì…˜ìœ¼ë¡œ í™•ì¥:

1. ì†Œê·œëª¨ (2,000ê±´) - ~18ì´ˆ
2. ì¤‘ê°„ê·œëª¨ (10,000ê±´) - ~90ì´ˆ
3. ëŒ€ê·œëª¨ (25,000ê±´) - ~3.75ë¶„
4. ì´ˆëŒ€ìš©ëŸ‰ (1,000,000ê±´) - ~22.5ë¶„ ğŸ†•
5. ë©”ê°€ìŠ¤ì¼€ì¼ (3,000,000ê±´) - ~2.7ì‹œê°„ ğŸ†•
6. ê¸°ê°€ìŠ¤ì¼€ì¼ (10,000,000ê±´) - ~13.5ì‹œê°„ ğŸ†•

ğŸ–¥ï¸ ìƒˆë¡œìš´ CLI ë„êµ¬

benchmark_cli.pyë¡œ ëª…ë ¹ì–´ ì‹¤í–‰ ê°€ëŠ¥:

# ê°„ë‹¨í•œ ì‹¤í–‰
python benchmark_cli.py --scale 1M

# ì°¨íŠ¸ì™€ CSV í•¨ê»˜ ìƒì„±
python benchmark_cli.py --scale 3M --charts --csv

# ë¹„ëŒ€í™”í˜• ëª¨ë“œ (ìë™ ì‹¤í–‰)
python benchmark_cli.py --scale 10M --no-interactive

ğŸ¯ ì‚¬ìš©ë²•:

ëŒ€í™”í˜• ì‹¤í–‰ (ê¸°ì¡´ ë°©ì‹):

python run_complete_benchmark.py
- 6ê°œ ì˜µì…˜ ì¤‘ ì„ íƒ ê°€ëŠ¥
- ëŒ€ìš©ëŸ‰ í…ŒìŠ¤íŠ¸ëŠ” ê²½ê³  ë©”ì‹œì§€ì™€ í•¨ê»˜ í™•ì¸ ìš”ì²­

CLI ì‹¤í–‰ (ìƒˆë¡œìš´ ë°©ì‹):

# 100ë§Œê±´ í…ŒìŠ¤íŠ¸ + ì°¨íŠ¸ + CSV
python benchmark_cli.py --scale 1M --charts --csv

# 1000ë§Œê±´ í…ŒìŠ¤íŠ¸ (ë¹„ëŒ€í™”í˜•)
python benchmark_cli.py --scale 10M --no-interactive

## ë¼ì´ì„¼ìŠ¤

ì´ í”„ë¡œì íŠ¸ëŠ” êµìœ¡ ëª©ì ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.